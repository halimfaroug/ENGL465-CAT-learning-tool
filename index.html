<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ENGL465 — Computer-Assisted Translation (CAT)</title>

  <style>
    :root{
      --bg0:#061812;
      --bg1:#08271b;
      --bg2:#0b3a2a;
      --card:rgba(255,255,255,.10);
      --card2:rgba(255,255,255,.14);
      --stroke:rgba(255,255,255,.18);
      --text:#ecfff6;
      --muted:rgba(236,255,246,.78);
      --muted2:rgba(236,255,246,.60);
      --accent:#38f2b0;
      --accent2:#7ad7ff;
      --warn:#ffd166;
      --danger:#ff5c7c;
      --ok:#4dff9a;
      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --r:18px;

      /* Requested */
      --font: 22px;
      --font2: 20px;
      --font3: 16px;

      /* PDF file names (place these PDFs next to this HTML file) */
      --pdf11: "ENGL465-Topic 11.pdf";
      --pdf12: "ENGL465-Topic 12.pdf";
      --pdf13: "ENGL465-Topic 13.pdf";
      --pdf14: "ENGL465-Topic 14.pdf";
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--text);
      font: 600 var(--font)/1.6 Calibri, "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      letter-spacing:.2px;
      background:
        radial-gradient(1200px 800px at 18% 10%, rgba(56,242,176,.22), transparent 60%),
        radial-gradient(1100px 700px at 78% 12%, rgba(122,215,255,.18), transparent 60%),
        radial-gradient(900px 600px at 55% 82%, rgba(255,209,102,.10), transparent 58%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Developer badge (upper right) */
    .devbadge{
      position:fixed;
      top:10px; right:12px;
      z-index:120;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(12px);
      box-shadow: 0 14px 36px rgba(0,0,0,.28);
      font-size: var(--font3);
      color: rgba(236,255,246,.88);
      font-weight:800;
      line-height:1.25;
      max-width: 360px;
    }
    .devbadge strong{ color: var(--text) }

    /* Scenic animated background layers */
    .scene{
      position:fixed; inset:0;
      z-index:-3;
      pointer-events:none;
      overflow:hidden;
    }

    .mist{
      position:absolute; inset:-25%;
      background:
        radial-gradient(700px 350px at 20% 30%, rgba(255,255,255,.10), transparent 66%),
        radial-gradient(650px 360px at 75% 38%, rgba(255,255,255,.08), transparent 68%),
        radial-gradient(820px 440px at 45% 74%, rgba(255,255,255,.06), transparent 70%);
      filter: blur(18px);
      animation: drift 20s ease-in-out infinite alternate;
      opacity:.55;
    }
    @keyframes drift{
      from{ transform: translate3d(-2%, -1%, 0) scale(1.03) }
      to{ transform: translate3d(2%, 1%, 0) scale(1.06) }
    }

    .hills{
      position:absolute; left:-10%; right:-10%; bottom:-14%;
      height:48vh;
      background:
        radial-gradient(60% 90% at 10% 90%, rgba(56,242,176,.10), transparent 62%),
        radial-gradient(55% 90% at 55% 95%, rgba(122,215,255,.10), transparent 62%),
        radial-gradient(50% 90% at 90% 92%, rgba(255,209,102,.08), transparent 64%),
        linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.22));
      filter: blur(0px);
      opacity:.9;
    }
    .hills:before,
    .hills:after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(120% 90% at 15% 100%, rgba(10,58,42,.85), transparent 62%),
        radial-gradient(120% 90% at 55% 108%, rgba(9,45,34,.92), transparent 64%),
        radial-gradient(120% 90% at 88% 102%, rgba(8,39,30,.88), transparent 66%);
      transform: translateY(10px);
      opacity:.95;
    }
    .hills:after{
      background:
        radial-gradient(120% 90% at 20% 112%, rgba(6,26,20,.92), transparent 66%),
        radial-gradient(120% 90% at 55% 118%, rgba(7,32,24,.96), transparent 68%),
        radial-gradient(120% 90% at 86% 114%, rgba(6,26,20,.92), transparent 66%);
      transform: translateY(26px);
      opacity:1;
    }

    /* Fireflies */
    .fly{
      position:absolute;
      width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.2) 35%, rgba(56,242,176,.00) 70%);
      box-shadow: 0 0 14px rgba(56,242,176,.55), 0 0 28px rgba(122,215,255,.25);
      opacity:0;
      animation: float 10s linear infinite;
    }
    @keyframes float{
      0%{ transform: translate3d(0, 24vh, 0) scale(.8); opacity:0 }
      10%{opacity:.85}
      50%{opacity:.55}
      90%{opacity:.80}
      100%{ transform: translate3d(22vw, -32vh, 0) scale(1.15); opacity:0 }
    }

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(6,24,18,.82), rgba(6,24,18,.52));
      border-bottom: 1px solid var(--stroke);
    }

    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px 10px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      min-width:280px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background:
        radial-gradient(20px 20px at 30% 30%, rgba(255,255,255,.80), rgba(255,255,255,.10) 60%, transparent 70%),
        linear-gradient(135deg, rgba(56,242,176,.95), rgba(122,215,255,.85));
      box-shadow: 0 14px 30px rgba(56,242,176,.18);
      border: 1px solid rgba(255,255,255,.22);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.35);
      opacity:.55;
    }
    .titleblock{display:flex; flex-direction:column; gap:2px}
    .course{
      font-size: 24px;
      letter-spacing:.3px;
      line-height:1.2;
      margin:0;
      font-weight:900;
    }
    .dev{
      font-size: var(--font3);
      color: var(--muted2);
      margin:0;
      font-weight:800;
    }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .chip{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .chip label{
      font-size: var(--font3);
      color: var(--muted);
      font-weight:900;
      letter-spacing:.2px;
      margin-right:2px;
    }
    .chip input[type="range"]{
      width:140px;
      accent-color: var(--accent);
    }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:10px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:900;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.20);
      font-size: var(--font2);
      font-family: Calibri, "Segoe UI", Arial, sans-serif;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.11); border-color: rgba(255,255,255,.26) }
    .btn:active{ transform: translateY(0px) scale(.99) }
    .btn.primary{
      background: linear-gradient(135deg, rgba(56,242,176,.95), rgba(122,215,255,.90));
      color:#042016;
      border-color: rgba(255,255,255,.35);
    }
    .btn.danger{
      background: rgba(255,92,124,.13);
      border-color: rgba(255,92,124,.35);
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.14);
      box-shadow:none;
    }

    .navwrap{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 14px;
    }
    nav{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight:950;
      font-size: var(--font2);
      transition: .14s ease;
      font-family: Calibri, "Segoe UI", Arial, sans-serif;
    }
    .tab:hover{ background: rgba(255,255,255,.10) }
    .tab.active{
      background: rgba(56,242,176,.18);
      border-color: rgba(56,242,176,.42);
      box-shadow: 0 12px 30px rgba(56,242,176,.14);
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 22px 18px 90px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.07));
      border:1px solid rgba(255,255,255,.16);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2, .card h3{
      margin:0 0 10px;
      line-height:1.25;
      letter-spacing:.2px;
    }
    .card h2{ font-size: 30px; font-weight:1000 }
    .card h3{ font-size: 24px; color: var(--text); font-weight:1000 }

    .card .pad{ padding:18px }
    .muted{ color: var(--muted) }
    .muted2{ color: var(--muted2) }
    .mini{ font-size: var(--font3); color: var(--muted2) }
    .pillrow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      font-size: var(--font3);
      font-weight:900;
    }

    .sidecard .stat{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.12);
      font-size: var(--font2);
      font-weight:850;
    }
    .sidecard .stat:first-child{ border-top:0 }
    .kpi{ font-weight:1000; color: var(--accent) }

    .section{ display:none }
    .section.active{ display:block }

    details{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding: 10px 12px;
      margin: 10px 0;
      overflow:hidden;
    }
    details[open]{ background: rgba(0,0,0,.16); border-color: rgba(56,242,176,.22) }
    summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:1000;
      color: var(--text);
      font-size: 22px;
    }
    summary::-webkit-details-marker{ display:none }
    .chev{
      width:12px;height:12px;border-right:3px solid rgba(255,255,255,.75);border-bottom:3px solid rgba(255,255,255,.75);
      transform: rotate(-45deg);
      transition: transform .12s ease;
      opacity:.8;
      flex:0 0 auto;
    }
    details[open] .chev{ transform: rotate(45deg) }

    .toolrow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:12px;
    }

    .search{
      flex:1;
      min-width:240px;
      padding:12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight:900;
      font-size: var(--font2);
      outline:none;
      font-family: Calibri, "Segoe UI", Arial, sans-serif;
    }
    .search::placeholder{ color: rgba(236,255,246,.55) }

    /* Footer */
    footer{
      position:fixed;
      left:0; right:0; bottom:0;
      background: linear-gradient(180deg, rgba(6,24,18,.08), rgba(6,24,18,.86));
      border-top:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(14px);
      z-index:60;
    }
    .foot{
      max-width:1200px;
      margin:0 auto;
      padding:10px 18px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      font-size: var(--font3);
      color: var(--muted2);
      font-weight:900;
    }
    .foot strong{ color: var(--muted) }

    /* PDF Library */
    .pdfgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      padding:18px;
    }
    @media (max-width: 980px){ .pdfgrid{ grid-template-columns: 1fr; } }

    .pdfcard{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding:14px;
    }
    .pdftitle{
      margin:0 0 6px;
      font-size: 22px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .pdfmeta{
      margin:0 0 12px;
      color: var(--muted2);
      font-size: var(--font3);
      font-weight:850;
    }
    .pdfviewer{
      width:100%;
      height: 68vh;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
      overflow:hidden;
    }
    iframe{
      width:100%;
      height:100%;
      border:0;
    }
    .note{
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,209,102,.25);
      background: rgba(255,209,102,.08);
      color: rgba(236,255,246,.92);
      font-size: var(--font3);
      font-weight:900;
      margin: 14px 18px 0;
    }
    a.link{
      color: var(--text);
      font-weight:950;
      text-decoration:none;
      border-bottom:1px dashed rgba(255,255,255,.35);
    }
    a.link:hover{ border-bottom-color: rgba(56,242,176,.75) }
  </style>
</head>

<body>
  <!-- Upper-right developer credit (requested) -->
  <div class="devbadge">
    <strong>Developer</strong><br/>
    Halim Faroug A. Elhag.<br/>
    BA (Honours), MA<br/>
    Lecturer at UHB l UofK
  </div>

  <div class="scene" aria-hidden="true">
    <div class="mist"></div>
    <div class="hills"></div>
    <!-- Fireflies injected by JS -->
  </div>

  <header>
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="titleblock">
          <h1 class="course">ENGL465 — Computer-Assisted Translation (CAT)</h1>
          <p class="dev">Developed by <strong>Ms. Halim Faroug A. Elhag, BA (Honours), MA — UHB/UofK</strong></p>
        </div>
      </div>

      <div class="controls">
        <button class="btn ghost" id="musicBtn" title="Play/Pause Ambient Audio">♪ Audio</button>
        <div class="chip" title="Adjust audio volume">
          <label for="vol">Volume</label>
          <input id="vol" type="range" min="0" max="100" value="35" />
        </div>
        <button class="btn" id="resetBtn" title="Reset progress on this device">Reset Progress</button>
        <button class="btn primary" id="quickStartBtn" title="Jump to today’s study flow">Study Flow</button>
      </div>
    </div>

    <div class="navwrap">
      <nav aria-label="Course navigation">
        <button class="tab active" data-target="home">Home</button>
        <button class="tab" data-target="terminology-tools">Terminology Tools for Translators</button>
        <button class="tab" data-target="minority-languages">Translation Technologies and Minority Languages</button>
        <button class="tab" data-target="commercial-mt">Inside Commercial Machine Translation</button>
        <button class="tab" data-target="pdf-lessons">Topics 11–14 (PDF Lessons)</button>
        <button class="tab" data-target="flashcards">Flashcards</button>
        <button class="tab" data-target="quizzes">Quizzes</button>
        <button class="tab" data-target="mindmaps">Mind Maps</button>
        <button class="tab" data-target="studio">CAT Studio</button>
        <button class="tab" data-target="review">Review</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="home" class="section active">
      <div class="grid">
        <div class="card">
          <div class="pad">
            <h2>Course Hub</h2>
            <p class="muted">
              This hub supports structured learning of core CAT themes with interactive practice:
              terminology management, technology gaps for minority languages, and commercial machine translation.
              New: Topics 11–14 PDFs are now built-in under <strong>Topics 11–14 (PDF Lessons)</strong>.
            </p>

            <details open>
              <summary>Learning Outcomes <span class="chev" aria-hidden="true"></span></summary>
              <div class="muted">
                <ul>
                  <li>Explain how terminology tools improve consistency, speed, and collaboration.</li>
                  <li>Distinguish term banks vs. termbases; identify what a complete term record contains.</li>
                  <li>Recognize why minority languages are underserved technologically and how resources can be built.</li>
                  <li>Describe how commercial MT is built, evaluated, and refined over time.</li>
                  <li>Use Topics 11–14 PDFs as your official reference content for study and review.</li>
                </ul>
              </div>
            </details>

            <details>
              <summary>How to Use This Hub <span class="chev" aria-hidden="true"></span></summary>
              <div class="muted">
                <ol>
                  <li>Use the PDF Lessons tab for Topics 11–14.</li>
                  <li>Use flashcards/quizzes/mind maps for drilling.</li>
                  <li>Use CAT Studio for term extraction and quick glossary building.</li>
                  <li>Progress saves automatically on this device.</li>
                </ol>
              </div>
            </details>

            <div class="pillrow">
              <span class="pill">Calibri 22 layout</span>
              <span class="pill">Offline audio</span>
              <span class="pill">PDF Lessons built-in</span>
              <span class="pill">Progress tracking</span>
            </div>
          </div>

          <div class="deckbar" style="padding:14px;border-top:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.10)">
            <div class="toolrow" style="margin-top:0">
              <input id="globalSearch" class="search" placeholder="Search flashcards, quizzes, mind maps…" />
              <button class="btn primary" id="searchBtn">Search</button>
              <button class="btn" id="randomBtn">Random Practice</button>
              <button class="btn" onclick="go('pdf-lessons')">Open PDF Lessons</button>
            </div>
          </div>
        </div>

        <div class="card sidecard">
          <div class="pad">
            <h3>Progress Snapshot</h3>
            <p class="mini">Saved locally on this device.</p>
          </div>
          <div class="stat"><span>Flashcards mastered</span><span class="kpi" id="sMastered">0</span></div>
          <div class="stat"><span>Quiz correct</span><span class="kpi" id="sCorrect">0</span></div>
          <div class="stat"><span>Quiz attempted</span><span class="kpi" id="sAttempted">0</span></div>
          <div class="stat"><span>Last activity</span><span class="kpi" id="sLast">—</span></div>
        </div>
      </div>
    </section>

    <!-- TERMINOLOGY TOOLS FOR TRANSLATORS -->
    <section id="terminology-tools" class="section">
      <div class="card">
        <div class="pad">
          <h2>Terminology Tools for Translators</h2>
          <p class="muted">
            Terminology work is time-consuming but non-negotiable. Clients often require preferred terms; good tooling prevents repeated research and improves clarity.
          </p>

          <details open>
            <summary>Introduction <span class="chev" aria-hidden="true"></span></summary>
            <div class="muted">
              <ul>
                <li><strong>Terminology</strong> = collecting, organizing, and using specialized terms (e.g., engineering, medicine, law).</li>
                <li>Accurate equivalents matter because specialized terms drive meaning, compliance, and user trust.</li>
                <li>Tools store/retrieve/update term records to keep usage consistent, reduce misunderstandings, and improve quality.</li>
              </ul>
            </div>
          </details>

          <details>
            <summary>Key Takeaway <span class="chev" aria-hidden="true"></span></summary>
            <div class="muted">
              Humans need fast and flexible entries; machines need strict and explicit data (POS, sense, constraints).
            </div>
          </details>

          <div class="toolrow">
            <button class="btn primary" onclick="openPractice('flashcards','terminology')">Flashcards</button>
            <button class="btn primary" onclick="openPractice('quizzes','terminology')">Quizzes</button>
            <button class="btn" onclick="openPractice('mindmaps','terminology')">Mind Map</button>
            <button class="btn" onclick="openPractice('studio','term')">CAT Studio</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TRANSLATION TECHNOLOGIES AND MINORITY LANGUAGES -->
    <section id="minority-languages" class="section">
      <div class="card">
        <div class="pad">
          <h2>Translation Technologies and Minority Languages</h2>
          <p class="muted">
            Translation technology tracks economic power. Major languages get MT/CAT ecosystems; many others lack even basic digital support.
          </p>

          <details open>
            <summary>Key Points <span class="chev" aria-hidden="true"></span></summary>
            <div class="muted">
              <ul>
                <li>Minority language: <strong>&lt; 50%</strong> in a geopolitical area + often non-official status.</li>
                <li>Resource tiers: high / mid / low-resource.</li>
                <li>Build resources: corpora → word lists → dictionaries → bilingual corpora/TM → richer tools.</li>
              </ul>
            </div>
          </details>

          <div class="toolrow">
            <button class="btn primary" onclick="openPractice('flashcards','minority')">Flashcards</button>
            <button class="btn primary" onclick="openPractice('quizzes','minority')">Quizzes</button>
            <button class="btn" onclick="openPractice('mindmaps','minority')">Mind Map</button>
            <button class="btn" onclick="openPractice('studio','resources')">CAT Studio</button>
          </div>
        </div>
      </div>
    </section>

    <!-- INSIDE COMMERCIAL MACHINE TRANSLATION -->
    <section id="commercial-mt" class="section">
      <div class="card">
        <div class="pad">
          <h2>Inside Commercial Machine Translation</h2>
          <p class="muted">
            MT is built in two major phases: creation (engine building) and continuous development (evaluation, refinement, user feedback).
          </p>

          <details open>
            <summary>Key Points <span class="chev" aria-hidden="true"></span></summary>
            <div class="muted">
              <ul>
                <li>Phase 1: RBMT / data-driven / hybrid, plus language-pair resource challenges.</li>
                <li>Phase 2: evaluation depends on purpose (gisting/dissemination/communication) + continuous refinement.</li>
                <li>Reality: MT assists; humans still decide meaning and appropriateness.</li>
              </ul>
            </div>
          </details>

          <div class="toolrow">
            <button class="btn primary" onclick="openPractice('flashcards','mt')">Flashcards</button>
            <button class="btn primary" onclick="openPractice('quizzes','mt')">Quizzes</button>
            <button class="btn" onclick="openPractice('mindmaps','mt')">Mind Map</button>
            <button class="btn" onclick="openPractice('studio','mt')">CAT Studio</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PDF LESSONS (Topics 11–14) -->
    <section id="pdf-lessons" class="section">
      <div class="card">
        <div class="pad">
          <h2>Topics 11–14 (PDF Lessons)</h2>
          <p class="muted">
            These are your official lesson files. To work offline, keep the PDFs in the <strong>same folder</strong> as this HTML file.
          </p>
        </div>

        <div class="note">
          If the PDF viewer shows blank: open the HTML via a local server (e.g., VS Code “Live Server”) or open the PDF directly.
        </div>

        <div class="pdfgrid">
          <div class="pdfcard">
            <p class="pdftitle">Topic 11</p>
            <p class="pdfmeta">File: <span id="f11"></span></p>
            <div class="toolrow">
              <button class="btn primary" onclick="loadPDF(pdfFiles.t11)">Open in Viewer</button>
              <a class="link" id="a11" href="#" target="_blank" rel="noopener">Open directly</a>
            </div>
          </div>

          <div class="pdfcard">
            <p class="pdftitle">Topic 12</p>
            <p class="pdfmeta">File: <span id="f12"></span></p>
            <div class="toolrow">
              <button class="btn primary" onclick="loadPDF(pdfFiles.t12)">Open in Viewer</button>
              <a class="link" id="a12" href="#" target="_blank" rel="noopener">Open directly</a>
            </div>
          </div>

          <div class="pdfcard">
            <p class="pdftitle">Topic 13</p>
            <p class="pdfmeta">File: <span id="f13"></span></p>
            <div class="toolrow">
              <button class="btn primary" onclick="loadPDF(pdfFiles.t13)">Open in Viewer</button>
              <a class="link" id="a13" href="#" target="_blank" rel="noopener">Open directly</a>
            </div>
          </div>

          <div class="pdfcard">
            <p class="pdftitle">Topic 14</p>
            <p class="pdfmeta">File: <span id="f14"></span></p>
            <div class="toolrow">
              <button class="btn primary" onclick="loadPDF(pdfFiles.t14)">Open in Viewer</button>
              <a class="link" id="a14" href="#" target="_blank" rel="noopener">Open directly</a>
            </div>
          </div>
        </div>

        <div class="pad">
          <h3>PDF Viewer</h3>
          <p class="mini muted2">Pick a topic above to load it here.</p>
          <div class="pdfviewer">
            <iframe id="pdfFrame" title="PDF Viewer"></iframe>
          </div>
        </div>
      </div>
    </section>

    <!-- FLASHCARDS / QUIZZES / MINDMAPS / STUDIO / REVIEW -->
    <!-- Kept from your original build (logic below). -->
    <section id="flashcards" class="section"><div class="card"><div class="pad"><h2>Flashcards</h2><p class="muted">Flip to reveal answers. Rate recall to train spaced review. Your progress saves automatically.</p><div class="toolrow"><button class="btn primary" onclick="setDeck('all')">All</button><button class="btn" onclick="setDeck('terminology')">Terminology</button><button class="btn" onclick="setDeck('minority')">Minority Languages</button><button class="btn" onclick="setDeck('mt')">Commercial MT</button><button class="btn" onclick="setDeck('weak')">Focus: Weak</button><button class="btn" onclick="shuffleDeck()">Shuffle</button></div></div><div class="deckbar" style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;padding:14px;border-top:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.10)"><div class="deckmeta" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;font-size:var(--font2);font-weight:900;color:var(--muted)"><span class="pill" id="deckName">Deck: All</span><span class="pill" id="deckCount">Cards: 0</span><span class="pill" id="deckPos">Card: 0 / 0</span></div><div class="toolrow" style="margin-top:0"><button class="btn" onclick="prevCard()">◀</button><button class="btn primary" onclick="flipCard()">Flip</button><button class="btn" onclick="nextCard()">▶</button></div></div><div class="flashwrap" id="flashMount" style="display:grid;grid-template-columns:1fr;gap:14px;padding:18px"></div></div></section>

    <section id="quizzes" class="section"><div class="card"><div class="pad"><h2>Quizzes</h2><p class="muted">Answer, submit, and get instant explanations. Questions rotate by theme or mixed mode.</p><div class="toolrow"><button class="btn primary" onclick="setQuizMode('mixed')">Mixed</button><button class="btn" onclick="setQuizMode('terminology')">Terminology</button><button class="btn" onclick="setQuizMode('minority')">Minority Languages</button><button class="btn" onclick="setQuizMode('mt')">Commercial MT</button><button class="btn" onclick="newQuiz()">New Set</button></div></div><div class="quizwrap" id="quizMount" style="padding:18px;display:grid;gap:14px"></div></div></section>

    <section id="mindmaps" class="section"><div class="card"><div class="pad"><h2>Mind Maps</h2><p class="muted">Click nodes to expand. Use them to revise quickly and link concepts across the course.</p><div class="toolrow"><button class="btn primary" onclick="setMap('all')">All</button><button class="btn" onclick="setMap('terminology')">Terminology</button><button class="btn" onclick="setMap('minority')">Minority Languages</button><button class="btn" onclick="setMap('mt')">Commercial MT</button></div></div><div class="mapwrap" id="mapMount" style="padding:18px;display:grid;gap:12px"></div></div></section>

    <section id="studio" class="section">
      <div class="card">
        <div class="pad">
          <h2>CAT Studio</h2>
          <p class="muted">Practical micro-tools: simulate term extraction, build a quick glossary, and practice MT evaluation choices.</p>
        </div>
        <div style="padding:18px;display:grid;gap:12px">
          <details open>
            <summary>Term Extraction Simulator <span class="chev" aria-hidden="true"></span></summary>
            <div class="muted">
              <p class="muted2 mini">Simulation only. Validate terms manually.</p>
              <textarea id="termText" placeholder="Paste a short source text here…" style="width:100%;min-height:140px;border-radius:16px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.16);color:var(--text);padding:12px 14px;font:900 var(--font2)/1.5 Calibri, Arial, sans-serif;outline:none;resize:vertical;"></textarea>
              <div class="toolrow">
                <button class="btn primary" onclick="runExtraction('linguistic')">Pattern-Based</button>
                <button class="btn primary" onclick="runExtraction('statistical')">Frequency-Based</button>
                <button class="btn" onclick="runExtraction('hybrid')">Hybrid</button>
                <button class="btn danger" onclick="clearStudio()">Clear</button>
              </div>
              <div id="termResult" style="border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.14);padding:12px 14px;font-size:var(--font2);font-weight:850;">
                <span class="muted2">Candidate terms will appear here.</span>
              </div>
            </div>
          </details>

          <details>
            <summary>Quick Glossary Builder <span class="chev" aria-hidden="true"></span></summary>
            <div class="muted">
              <p class="mini muted2">Add terms and export as a simple table (copy/paste).</p>
              <div class="toolrow">
                <input class="search" id="gTerm" placeholder="Term (source)" />
                <input class="search" id="gEq" placeholder="Equivalent (target)" />
                <input class="search" id="gNote" placeholder="Note (domain / usage / context)" />
                <button class="btn primary" onclick="addGloss()">Add</button>
                <button class="btn" onclick="exportGloss()">Export</button>
                <button class="btn danger" onclick="clearGloss()">Clear</button>
              </div>
              <div id="glossOut" style="border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.14);padding:12px 14px;font-size:var(--font2);font-weight:850;">
                <span class="muted2">No entries yet.</span>
              </div>
            </div>
          </details>

          <details>
            <summary>MT Evaluation Choice Trainer <span class="chev" aria-hidden="true"></span></summary>
            <div class="muted">
              <p class="mini muted2">Select the correct purpose category and see the reasoning.</p>
              <div id="mtTrainer"></div>
            </div>
          </details>
        </div>
      </div>
    </section>

    <section id="review" class="section">
      <div class="card">
        <div class="pad">
          <h2>Review</h2>
          <p class="muted">High-yield recap + common traps + exam checklist.</p>

          <details open>
            <summary>High-Yield Summary <span class="chev" aria-hidden="true"></span></summary>
            <div class="muted">
              <ul>
                <li><strong>Terminology tools:</strong> consistency + speed + collaboration; extraction = linguistic/statistical/hybrid.</li>
                <li><strong>Minority languages:</strong> definition = size + status; resource tiers; build via corpora → word lists → dictionaries → TM.</li>
                <li><strong>Commercial MT:</strong> phase 1 creation + phase 2 development; evaluation depends on purpose; humans remain essential.</li>
                <li><strong>Topics 11–14:</strong> use the PDF Lessons tab as your authoritative reference.</li>
              </ul>
            </div>
          </details>

          <details>
            <summary>Fast Answer Checklist <span class="chev" aria-hidden="true"></span></summary>
            <div class="muted">
              <ul>
                <li>State the definition.</li>
                <li>List the core categories.</li>
                <li>Give one concrete example.</li>
                <li>End with workflow impact (time/quality/cost/feasibility).</li>
              </ul>
            </div>
          </details>

          <div class="toolrow">
            <button class="btn primary" onclick="go('pdf-lessons')">PDF Lessons</button>
            <button class="btn primary" onclick="go('flashcards')">Flashcards</button>
            <button class="btn" onclick="go('quizzes')">Quizzes</button>
            <button class="btn" onclick="go('mindmaps')">Mind Maps</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="foot">
      <div><strong>ENGL465</strong> — Computer-Assisted Translation (CAT)</div>
      <div id="statusLine">Ready.</div>
    </div>
  </footer>

  <script>
    /***********************
     * Status helper
     ***********************/
    function setStatus(msg){
      document.getElementById('statusLine').textContent = msg;
      touchActivity();
    }

    /***********************
     * PDF Lessons (Topics 11–14)
     * Keep PDFs in same folder as this HTML:
     * - ENGL465-Topic 11.pdf
     * - ENGL465-Topic 12.pdf
     * - ENGL465-Topic 13.pdf
     * - ENGL465-Topic 14.pdf
     ***********************/
    const pdfFiles = {
      t11: "ENGL465-Topic 11.pdf",
      t12: "ENGL465-Topic 12.pdf",
      t13: "ENGL465-Topic 13.pdf",
      t14: "ENGL465-Topic 14.pdf",
    };

    function initPDFLinks(){
      const map = [
        ["f11","a11",pdfFiles.t11],
        ["f12","a12",pdfFiles.t12],
        ["f13","a13",pdfFiles.t13],
        ["f14","a14",pdfFiles.t14],
      ];
      map.forEach(([fid, aid, file])=>{
        const span = document.getElementById(fid);
        const a = document.getElementById(aid);
        if(span) span.textContent = file;
        if(a){
          a.href = encodeURI(file);
          a.textContent = "Open directly";
        }
      });
    }

    function loadPDF(file){
      const frame = document.getElementById("pdfFrame");
      if(!frame) return;
      frame.src = encodeURI(file);
      setStatus("Loaded PDF: " + file);
    }

    /***********************
     * Ambient “nature” audio (offline) using Web Audio API
     * Upgraded: wind + soft pad + gentle water shimmer
     ***********************/
    let audioCtx = null, master = null, isPlaying = false, nodes = [];
    const musicBtn = document.getElementById('musicBtn');
    const vol = document.getElementById('vol');

    function initAudio(){
      if(audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      master = audioCtx.createGain();
      master.gain.value = (Number(vol.value)/100) * 0.55;
      master.connect(audioCtx.destination);
    }

    function makeWind(){
      const bufferSize = 2 * audioCtx.sampleRate;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      for (let i=0;i<bufferSize;i++) output[i] = (Math.random()*2-1) * 0.32;

      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      noise.loop = true;

      const filter = audioCtx.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 620;
      filter.Q.value = 0.8;

      const lfo = audioCtx.createOscillator();
      lfo.type = 'sine';
      lfo.frequency.value = 0.055;

      const lfoGain = audioCtx.createGain();
      lfoGain.gain.value = 210;

      lfo.connect(lfoGain);
      lfoGain.connect(filter.frequency);

      const g = audioCtx.createGain();
      g.gain.value = 0.22;

      noise.connect(filter);
      filter.connect(g);
      g.connect(master);

      return {noise, filter, lfo, lfoGain, g};
    }

    function makePads(){
      const g = audioCtx.createGain();
      g.gain.value = 0.095;

      const chord = [
        {freq: 196.00, detune: -6}, // G3
        {freq: 246.94, detune:  3}, // B3
        {freq: 293.66, detune:  8}, // D4
      ];

      const osc = chord.map(c=>{
        const o = audioCtx.createOscillator();
        o.type = 'sine';
        o.frequency.value = c.freq;
        o.detune.value = c.detune;
        return o;
      });

      const filt = audioCtx.createBiquadFilter();
      filt.type = 'lowpass';
      filt.frequency.value = 880;
      filt.Q.value = 0.9;

      const trem = audioCtx.createOscillator();
      trem.type = 'sine';
      trem.frequency.value = 0.08;
      const tremGain = audioCtx.createGain();
      tremGain.gain.value = 0.04;
      trem.connect(tremGain);
      tremGain.connect(g.gain);

      osc.forEach(o=>o.connect(filt));
      filt.connect(g);
      g.connect(master);

      return {osc, filt, g, trem, tremGain};
    }

    function makeWater(){
      // soft “water” shimmer: bandpassed noise with slow amplitude motion
      const bufferSize = 2 * audioCtx.sampleRate;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      for (let i=0;i<bufferSize;i++) output[i] = (Math.random()*2-1) * 0.18;

      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      noise.loop = true;

      const band = audioCtx.createBiquadFilter();
      band.type = 'bandpass';
      band.frequency.value = 950;
      band.Q.value = 0.9;

      const g = audioCtx.createGain();
      g.gain.value = 0.06;

      const lfo = audioCtx.createOscillator();
      lfo.type = 'sine';
      lfo.frequency.value = 0.12;

      const lfoGain = audioCtx.createGain();
      lfoGain.gain.value = 0.02;

      lfo.connect(lfoGain);
      lfoGain.connect(g.gain);

      noise.connect(band);
      band.connect(g);
      g.connect(master);

      return {noise, band, g, lfo, lfoGain};
    }

    function startAudio(){
      initAudio();
      if(audioCtx.state === 'suspended') audioCtx.resume();

      const wind = makeWind();
      const pads = makePads();
      const water = makeWater();

      nodes = [
        wind.noise, wind.lfo,
        ...pads.osc, pads.trem,
        water.noise, water.lfo
      ];

      wind.noise.start(); wind.lfo.start();
      pads.osc.forEach(o=>o.start()); pads.trem.start();
      water.noise.start(); water.lfo.start();

      isPlaying = true;
      musicBtn.textContent = "❚❚ Audio";
      setStatus("Audio on.");
    }

    function stopAudio(){
      try{ nodes.forEach(n=>{ try{ n.stop(); }catch(e){} }); }
      finally{ nodes = []; }
      isPlaying = false;
      musicBtn.textContent = "♪ Audio";
      setStatus("Audio off.");
    }

    musicBtn.addEventListener('click', ()=>{
      if(!isPlaying) startAudio();
      else stopAudio();
    });

    vol.addEventListener('input', ()=>{
      if(master) master.gain.value = (Number(vol.value)/100) * 0.55;
    });

    /***********************
     * Fireflies
     ***********************/
    const scene = document.querySelector('.scene');
    function spawnFireflies(){
      for(let i=0;i<16;i++){
        const d = document.createElement('div');
        d.className = 'fly';
        const left = Math.random()*100;
        const top = 65 + Math.random()*45;
        const delay = Math.random()*10;
        const dur = 8 + Math.random()*10;
        d.style.left = left + 'vw';
        d.style.top = top + 'vh';
        d.style.animationDelay = delay + 's';
        d.style.animationDuration = dur + 's';
        scene.appendChild(d);
      }
    }
    spawnFireflies();

    /***********************
     * Navigation
     ***********************/
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const sections = Array.from(document.querySelectorAll('.section'));

    function go(id){
      sections.forEach(s=>s.classList.toggle('active', s.id === id));
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.target === id));
      setStatus("Opened: " + tabLabel(id));
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function tabLabel(id){
      const t = tabs.find(x=>x.dataset.target===id);
      return t ? t.textContent.trim() : id;
    }

    tabs.forEach(t=>t.addEventListener('click', ()=>go(t.dataset.target)));

    document.getElementById('quickStartBtn').addEventListener('click', ()=>{
      go('terminology-tools');
      setTimeout(()=>openPractice('flashcards','terminology'), 200);
    });

    /***********************
     * Local progress
     ***********************/
    const KEY = "ENGL465_CAT_PROGRESS_V2";

    function loadProgress(){
      try{
        return JSON.parse(localStorage.getItem(KEY)) || {
          flash:{},
          quiz:{attempted:0, correct:0},
          streak:{count:0, lastDay:null},
          lastActivity:null,
          glossary:[]
        };
      }catch(e){
        return {flash:{}, quiz:{attempted:0, correct:0}, streak:{count:0,lastDay:null}, lastActivity:null, glossary:[]};
      }
    }
    function saveProgress(p){
      localStorage.setItem(KEY, JSON.stringify(p));
      renderStats();
    }

    function todayKey(){
      const d = new Date();
      return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0');
    }

    function touchActivity(){
      const p = loadProgress();
      p.lastActivity = new Date().toISOString();

      const tk = todayKey();
      if(p.streak.lastDay !== tk){
        if(!p.streak.lastDay){
          p.streak.count = 1;
        }else{
          const last = new Date(p.streak.lastDay+"T00:00:00");
          const now = new Date(tk+"T00:00:00");
          const diffDays = Math.round((now-last)/(1000*60*60*24));
          if(diffDays === 1) p.streak.count += 1;
          else p.streak.count = 1;
        }
        p.streak.lastDay = tk;
      }
      saveProgress(p);
    }

    function renderStats(){
      const p = loadProgress();
      const mastered = Object.values(p.flash).filter(x=>x.score>=2).length;
      const attempted = p.quiz.attempted || 0;
      const correct = p.quiz.correct || 0;

      document.getElementById('sMastered').textContent = mastered;
      document.getElementById('sAttempted').textContent = attempted;
      document.getElementById('sCorrect').textContent = correct;

      const last = p.lastActivity ? new Date(p.lastActivity) : null;
      document.getElementById('sLast').textContent = last ? last.toLocaleString() : "—";
    }
    renderStats();

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      localStorage.removeItem(KEY);
      renderStats();
      setStatus("Progress cleared.");
      mountFlash();
      newQuiz();
      renderMaps();
      renderGloss();
    });

    /***********************
     * Data: Flashcards (kept from your original)
     ***********************/
    const flashcards = [
      {id:"t1", deck:"terminology", term:"Terminology", def:"Collecting, organizing, and using specialized terms in specific fields (e.g., medicine, law, engineering).", hint:"Focus: specialized meaning and consistency."},
      {id:"t2", deck:"terminology", term:"Terminology management", def:"A workflow for storing, retrieving, updating, and enforcing preferred terms across translation projects.", hint:"Impact: time, cost, quality."},
      {id:"t3", deck:"terminology", term:"Term record", def:"A structured profile for a single concept, possibly multilingual, including definition, equivalents, grammar, and usage notes.", hint:"One concept, many fields."},
      {id:"t4", deck:"terminology", term:"Term bank", def:"Comprehensive terminology resource (encyclopedic), often with definitions, synonyms, grammar, and usage notes for broad audiences.", hint:"Rich entry."},
      {id:"t5", deck:"terminology", term:"Termbase", def:"Operational translator-focused list with essential information (equivalent + brief guidance), used in fast workflows like localization.", hint:"Short, practical entry."},
      {id:"t8", deck:"terminology", term:"Automated term extraction", def:"Software scans documents and proposes candidate terms for glossary building, reducing manual collection time.", hint:"Humans still verify."},
      {id:"t15", deck:"terminology", term:"Linguistic term extraction", def:"Identifies candidates using grammar patterns (e.g., adjective+noun). Risks: noise and silence; language dependence.", hint:"Pattern, not frequency."},
      {id:"t16", deck:"terminology", term:"Statistical term extraction", def:"Identifies candidates using frequency/co-occurrence. Works across languages; risks noise/silence; uses thresholds and stop lists.", hint:"Frequency signal."},
      {id:"t17", deck:"terminology", term:"Hybrid extraction", def:"Combines grammar-pattern and frequency signals to improve precision and recall.", hint:"Best of both."},
      {id:"t18", deck:"terminology", term:"Noise", def:"Extracted items that are not real terms.", hint:"False positives."},
      {id:"t19", deck:"terminology", term:"Silence", def:"Important terms that the extraction misses.", hint:"False negatives."},

      {id:"m1", deck:"minority", term:"Minority language", def:"Spoken by fewer than 50% of the population within a geopolitical area; often lacks official institutional support.", hint:"Number + status."},
      {id:"m3", deck:"minority", term:"High-resource language", def:"Has advanced MT/CAT systems, dictionaries, and spell/grammar checkers (strong digital support).", hint:"Full toolset."},
      {id:"m5", deck:"minority", term:"Low-resource language", def:"Lacks even basic digital tools; often excluded from technological ecosystems.", hint:"Digital marginalization."},
      {id:"m13", deck:"minority", term:"Bilingual corpora", def:"Parallel texts in two languages; support vocabulary extraction and translation memory building.", hint:"Parallel data."},

      {id:"x1", deck:"mt", term:"Machine Translation (MT)", def:"Automatic translation by computers; improved over time but still limited by ambiguity, data, and context.", hint:"Automation + limits."},
      {id:"x4", deck:"mt", term:"Rule-Based MT (RBMT)", def:"Linguists manually encode grammar rules and dictionaries; structured but weak for idioms/informal language.", hint:"Rules-driven."},
      {id:"x5", deck:"mt", term:"Data-driven MT", def:"Learns translation patterns from large bilingual datasets (statistical/example-based); needs a lot of data.", hint:"Data-hungry."},
      {id:"x14", deck:"mt", term:"Post-editing", def:"Human correction of MT output to reach required quality and reduce errors.", hint:"Human-in-the-loop."},
    ];

    /***********************
     * Flashcards UI (same behavior)
     ***********************/
    let deckMode = 'all';
    let deck = [];
    let deckIndex = 0;

    function cardScore(id){
      const p = loadProgress();
      return p.flash[id]?.score ?? 0;
    }
    function scoreLabel(s){
      if(s>=2) return "Mastered";
      if(s===1) return "Good";
      if(s===-1) return "Weak";
      return "New";
    }
    function setDeck(mode){
      deckMode = mode;
      buildDeck();
      deckIndex = 0;
      mountFlash();
      go('flashcards');
      setStatus("Deck set: " + modeLabel(mode));
    }
    function modeLabel(mode){
      if(mode==='all') return "All";
      if(mode==='terminology') return "Terminology";
      if(mode==='minority') return "Minority Languages";
      if(mode==='mt') return "Commercial MT";
      if(mode==='weak') return "Focus: Weak";
      if(mode==='mixed') return "Mixed";
      return mode;
    }
    function buildDeck(){
      if(deckMode==='all') deck = [...flashcards];
      else if(deckMode==='weak'){
        deck = flashcards.filter(c=>cardScore(c.id)===-1 || cardScore(c.id)===0);
      } else {
        deck = flashcards.filter(c=>c.deck===deckMode);
      }
      if(deck.length===0) deck = [...flashcards];
      document.getElementById('deckName').textContent = "Deck: " + modeLabel(deckMode);
      document.getElementById('deckCount').textContent = "Cards: " + deck.length;
    }

    function mountFlash(){
      buildDeck();
      const mount = document.getElementById('flashMount');
      mount.innerHTML = "";

      const c = deck[deckIndex];
      if(!c){
        mount.innerHTML = "<div class='muted2'>No cards.</div>";
        return;
      }

      const s = cardScore(c.id);
      const tagText = scoreLabel(s);

      const wrapper = document.createElement('div');
      wrapper.className = 'flashcard';
      wrapper.id = 'activeCard';
      wrapper.style.perspective = "1200px";
      wrapper.style.height = "240px";
      wrapper.style.borderRadius = "18px";
      wrapper.style.position = "relative";

      wrapper.innerHTML = `
        <div class="flashinner" style="position:absolute;inset:0;transform-style:preserve-3d;transition:transform .55s cubic-bezier(.2,.8,.2,1);border-radius:18px">
          <div class="face front" style="position:absolute;inset:0;backface-visibility:hidden;border-radius:18px;border:1px solid rgba(255,255,255,.18);box-shadow:0 18px 40px rgba(0,0,0,.22);overflow:hidden;display:flex;flex-direction:column;background:radial-gradient(800px 320px at 20% 10%, rgba(56,242,176,.18), transparent 60%),linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));">
            <div style="padding:16px 16px 10px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:space-between;gap:10px">
              <p style="font-size:28px;font-weight:1000;margin:0;line-height:1.2">${escapeHtml(c.term)}</p>
              <span style="padding:7px 10px;border-radius:999px;font-size:var(--font3);font-weight:950;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.16);color:var(--muted);white-space:nowrap">${escapeHtml(modeLabel(c.deck))}</span>
            </div>
            <div style="padding:14px 16px 16px;display:flex;flex:1;flex-direction:column;justify-content:space-between;gap:12px">
              <div style="font-size:20px;color:var(--muted2);font-weight:900">Tap <strong>Flip</strong> to reveal the answer.</div>
              <div style="font-size:var(--font3);color:var(--muted2);font-weight:900">Recall rating: <strong>${tagText}</strong></div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <button class="btn danger" onclick="rateCard('${c.id}', -1)">Weak</button>
                <button class="btn" onclick="rateCard('${c.id}', 1)">Good</button>
                <button class="btn primary" onclick="rateCard('${c.id}', 2)">Mastered</button>
              </div>
            </div>
          </div>

          <div class="face back" style="position:absolute;inset:0;backface-visibility:hidden;border-radius:18px;border:1px solid rgba(255,255,255,.18);box-shadow:0 18px 40px rgba(0,0,0,.22);overflow:hidden;display:flex;flex-direction:column;transform:rotateY(180deg);background:radial-gradient(800px 320px at 20% 10%, rgba(122,215,255,.18), transparent 60%),linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));">
            <div style="padding:16px 16px 10px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:space-between;gap:10px">
              <p style="font-size:28px;font-weight:1000;margin:0;line-height:1.2">${escapeHtml(c.term)}</p>
              <span style="padding:7px 10px;border-radius:999px;font-size:var(--font3);font-weight:950;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.16);color:var(--muted);white-space:nowrap">${escapeHtml(tagText)}</span>
            </div>
            <div style="padding:14px 16px 16px;display:flex;flex:1;flex-direction:column;justify-content:space-between;gap:12px">
              <div style="font-size:20px;color:var(--text);font-weight:850">${escapeHtml(c.def)}</div>
              <div style="font-size:var(--font3);color:var(--muted2);font-weight:900">${escapeHtml(c.hint || "")}</div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                <button class="btn danger" onclick="rateCard('${c.id}', -1)">Weak</button>
                <button class="btn" onclick="rateCard('${c.id}', 1)">Good</button>
                <button class="btn primary" onclick="rateCard('${c.id}', 2)">Mastered</button>
              </div>
            </div>
          </div>
        </div>
      `;

      mount.appendChild(wrapper);

      wrapper.addEventListener('click', (e)=>{
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        if(tag === "button" || tag === "a" || tag === "input") return;
        flipCard();
      });

      document.getElementById('deckPos').textContent = "Card: " + (deckIndex+1) + " / " + deck.length;
    }

    function flipCard(){
      const el = document.getElementById('activeCard');
      if(!el) return;
      const inner = el.querySelector('.flashinner');
      if(!inner) return;
      inner.style.transform = inner.style.transform.includes("180") ? "rotateY(0deg)" : "rotateY(180deg)";
    }
    function nextCard(){
      if(deck.length===0) return;
      deckIndex = (deckIndex+1) % deck.length;
      mountFlash();
    }
    function prevCard(){
      if(deck.length===0) return;
      deckIndex = (deckIndex-1 + deck.length) % deck.length;
      mountFlash();
    }
    function shuffleDeck(){
      for(let i=deck.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      deckIndex = 0;
      mountFlash();
      setStatus("Deck shuffled.");
    }
    function rateCard(id, score){
      const p = loadProgress();
      p.flash[id] = {score, last: new Date().toISOString()};
      saveProgress(p);
      setStatus("Card rated: " + scoreLabel(score));
      if(score>=1) setTimeout(()=>nextCard(), 180);
    }

    /***********************
     * Quizzes (trimmed set for speed; expand if you want)
     ***********************/
    const quizBank = [
      {id:"q1", theme:"terminology", q:"Terminology tools primarily improve which three outcomes?", opts:["Consistency, speed, collaboration","Creativity, style, humor","Rhythm, rhyme, meter","Pronunciation, intonation, stress"], a:0, why:"They enforce preferred terms, accelerate insertion, and enable shared glossaries."},
      {id:"q2", theme:"minority", q:"A minority language is defined mainly by:", opts:["Speaker proportion (<50%) and lack of official support","Being unpopular on social media","Having only one dialect","Being used only in poetry"], a:0, why:"Definition includes numerical size and non-official status."},
      {id:"q3", theme:"mt", q:"Commercial MT is often described in two phases. These are:", opts:["Creation and ongoing development","Writing and publishing","Scanning and printing","Rhyme and meter"], a:0, why:"Phase 1 = building; Phase 2 = refinement over time."},
      {id:"q4", theme:"terminology", q:"In term extraction, 'noise' refers to:", opts:["Non-terms incorrectly extracted","Terms that appear once","Correct terms only","File corruption"], a:0, why:"Noise = false positives."},
      {id:"q5", theme:"mt", q:"Which role is most realistic for MT in professional settings?", opts:["A productivity tool that still needs human oversight","A full replacement for translators","A tool only for poems","A tool that never improves"], a:0, why:"MT supports translators; it’s not fully autonomous."},
    ];

    let quizMode = 'mixed';
    let quizSet = [];

    function setQuizMode(mode){
      quizMode = mode;
      newQuiz();
      go('quizzes');
      setStatus("Quiz mode: " + modeLabel(mode));
    }

    function newQuiz(){
      const bank = (quizMode === 'mixed') ? quizBank : quizBank.filter(q=>q.theme===quizMode);
      quizSet = pickRandom(bank, Math.min(5, bank.length));
      renderQuiz();
      setStatus("New quiz set loaded.");
    }

    function renderQuiz(){
      const mount = document.getElementById('quizMount');
      mount.innerHTML = "";
      quizSet.forEach((q, i)=>{
        const qc = document.createElement('div');
        qc.style.border = "1px solid rgba(255,255,255,.14)";
        qc.style.background = "rgba(0,0,0,.14)";
        qc.style.borderRadius = "16px";
        qc.style.padding = "14px";

        qc.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-bottom:10px">
            <p style="margin:0;font-weight:1000;font-size:22px">${escapeHtml(q.q)}</p>
            <div style="font-size:var(--font3);color:var(--muted2);font-weight:900;white-space:nowrap">${escapeHtml(modeLabel(q.theme))} • Q${i+1}</div>
          </div>
          <div class="opts" style="display:grid;gap:10px;margin-top:10px">
            ${q.opts.map((o, idx)=>`<div class="opt" role="button" tabindex="0" data-idx="${idx}"
              style="padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);cursor:pointer;font-weight:900;font-size:var(--font2);transition:.12s ease">${escapeHtml(o)}</div>`).join('')}
          </div>
          <div class="toolrow" style="margin-top:12px">
            <button class="btn primary" data-action="submit">Submit</button>
            <button class="btn" data-action="reveal">Reveal</button>
          </div>
          <div class="feedback" id="fb-${q.id}" style="margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.16);font-size:var(--font2);font-weight:850;display:none"></div>
        `;

        qc.querySelectorAll('.opt').forEach(opt=>{
          opt.addEventListener('click', ()=>{
            qc.querySelectorAll('.opt').forEach(x=>{
              x.style.borderColor = "rgba(255,255,255,.14)";
              x.style.background = "rgba(255,255,255,.06)";
              x.dataset.sel = "0";
            });
            opt.style.borderColor = "rgba(56,242,176,.45)";
            opt.style.background = "rgba(56,242,176,.12)";
            opt.dataset.sel = "1";
          });
          opt.addEventListener('keydown', (e)=>{
            if(e.key==="Enter" || e.key===" "){ e.preventDefault(); opt.click(); }
          });
        });

        qc.querySelector('[data-action="submit"]').addEventListener('click', ()=>{
          const selected = Array.from(qc.querySelectorAll('.opt')).find(x=>x.dataset.sel==="1");
          const fb = document.getElementById('fb-'+q.id);
          if(!selected){
            fb.style.display = "block";
            fb.style.borderColor = "rgba(255,92,124,.45)";
            fb.style.background = "rgba(255,92,124,.10)";
            fb.textContent = "Select an option first.";
            return;
          }
          const idx = Number(selected.dataset.idx);
          const correct = (idx === q.a);

          const p = loadProgress();
          p.quiz.attempted += 1;
          if(correct) p.quiz.correct += 1;
          saveProgress(p);

          fb.style.display = "block";
          fb.style.borderColor = correct ? "rgba(77,255,154,.40)" : "rgba(255,92,124,.45)";
          fb.style.background = correct ? "rgba(77,255,154,.10)" : "rgba(255,92,124,.10)";
          fb.textContent = (correct ? "Correct. " : "Incorrect. ") + q.why;

          setStatus(correct ? "Correct answer logged." : "Attempt logged.");
        });

        qc.querySelector('[data-action="reveal"]').addEventListener('click', ()=>{
          const fb = document.getElementById('fb-'+q.id);
          fb.style.display = "block";
          fb.style.borderColor = "rgba(77,255,154,.40)";
          fb.style.background = "rgba(77,255,154,.10)";
          fb.textContent = "Answer: " + q.opts[q.a] + " — " + q.why;
          setStatus("Answer revealed.");
        });

        mount.appendChild(qc);
      });
      renderStats();
    }

    /***********************
     * Mind maps (kept minimal)
     ***********************/
    const maps = [
      { id:"map1", theme:"terminology", title:"Terminology Tools — Concept Map",
        nodes:[
          {label:"Term bank vs termbase", sub:["Term bank: rich entry","Termbase: operational, fast (localization)"]},
          {label:"Extraction", sub:["Linguistic (patterns)","Statistical (frequency)","Hybrid reduces noise/silence"]},
          {label:"Benefits", sub:["Consistency","Speed","Collaboration (sharing/TBX)"]},
        ]
      },
      { id:"map2", theme:"minority", title:"Minority Languages — Resource Map",
        nodes:[
          {label:"Definition", sub:["<50% speakers in area","Often non-official status"]},
          {label:"Resource tiers", sub:["High / Mid / Low-resource","Digital inequality follows power/funding"]},
          {label:"Build", sub:["Corpora → word lists","Dictionaries/spell-checkers","Bilingual corpora → TM"]},
        ]
      },
      { id:"map3", theme:"mt", title:"Commercial MT — Two-Phase Map",
        nodes:[
          {label:"Phase 1", sub:["RBMT","Data-driven","Hybrid"]},
          {label:"Phase 2", sub:["Evaluate by purpose","Refine with data updates","User feedback/post-editing"]},
          {label:"Reality", sub:["Best for structured text","Humans still judge meaning"]},
        ]
      },
    ];

    let mapMode = "all";
    function setMap(mode){
      mapMode = mode;
      renderMaps();
      go('mindmaps');
      setStatus("Mind maps filtered: " + modeLabel(mode));
    }
    function renderMaps(){
      const mount = document.getElementById('mapMount');
      mount.innerHTML = "";
      const chosen = (mapMode==="all") ? maps : maps.filter(m=>m.theme===mapMode);

      chosen.forEach(m=>{
        const wrap = document.createElement('div');
        wrap.style.borderRadius="16px";
        wrap.style.border="1px solid rgba(255,255,255,.14)";
        wrap.style.background="rgba(0,0,0,.14)";
        wrap.style.overflow="hidden";

        wrap.innerHTML = `
          <div style="padding:12px 14px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;border-bottom:1px solid rgba(255,255,255,.10);font-weight:1000;font-size:22px">
            <span>${escapeHtml(m.title)}</span>
            <span class="mini muted2">${escapeHtml(modeLabel(m.theme))}</span>
          </div>
          <div style="padding:14px">
            ${m.nodes.map((n,idx)=>`
              <div class="node" data-mid="${m.id}" data-idx="${idx}"
                style="display:inline-flex;align-items:center;gap:8px;padding:10px 12px;margin:8px 8px 0 0;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);cursor:pointer;font-weight:950;font-size:var(--font2);transition:.12s ease">
                ${escapeHtml(n.label)}
              </div>
              <div class="subnodes" id="sub-${m.id}-${idx}" style="margin-top:10px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.18);display:none">
                ${n.sub.map(s=>`
                  <div style="display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);margin-top:10px;font-size:var(--font2);font-weight:850;color:var(--text)">
                    <span style="width:10px;height:10px;border-radius:50%;background:rgba(56,242,176,.9);margin-top:7px;box-shadow:0 0 14px rgba(56,242,176,.35);flex:0 0 auto"></span>
                    <span>${escapeHtml(s)}</span>
                  </div>
                `).join('')}
              </div>
            `).join('')}
          </div>
        `;
        wrap.querySelectorAll('.node').forEach(node=>{
          node.addEventListener('click', ()=>{
            const mid = node.dataset.mid;
            const idx = node.dataset.idx;
            const box = document.getElementById(`sub-${mid}-${idx}`);
            box.style.display = (box.style.display === "block") ? "none" : "block";
          });
        });
        mount.appendChild(wrap);
      });
    }

    /***********************
     * CAT Studio
     ***********************/
    function clearStudio(){
      document.getElementById('termText').value = "";
      document.getElementById('termResult').innerHTML = `<span class="muted2">Candidate terms will appear here.</span>`;
      setStatus("Studio cleared.");
    }

    function runExtraction(mode){
      const text = (document.getElementById('termText').value || "").trim();
      const box = document.getElementById('termResult');
      if(!text){
        box.innerHTML = `<span class="muted2">Paste text first.</span>`;
        return;
      }

      const tokens = text
        .replace(/[^\w\s\-’']/g, " ")
        .replace(/\s+/g, " ")
        .trim()
        .split(" ");

      const stop = new Set(["the","a","an","and","or","but","to","of","in","on","for","with","by","as","is","are","was","were","be","been","this","that","these","those","it","its","their","they","we","you","i","at","from","into","over","under","than","then","which","who","whom","can","could","should","would","may","might","will","also","not"]);

      const uni = new Map();
      const bi = new Map();

      for(let i=0;i<tokens.length;i++){
        const w = tokens[i].toLowerCase();
        if(w.length>=4 && !stop.has(w)) uni.set(w,(uni.get(w)||0)+1);
        if(i<tokens.length-1){
          const w2 = tokens[i+1].toLowerCase();
          if(!stop.has(w) && !stop.has(w2) && w.length>=3 && w2.length>=3){
            const pair = w + " " + w2;
            bi.set(pair,(bi.get(pair)||0)+1);
          }
        }
      }

      const linguistic = new Set();
      const stat = new Set();

      const capSeq = text.match(/\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2})\b/g) || [];
      capSeq.forEach(x=>linguistic.add(x.trim()));
      (text.match(/\b\w+(?:-\w+)+\b/g) || []).forEach(x=>linguistic.add(x));

      ["term record","term bank","termbase","term extraction","translation memory","machine translation","computer-assisted translation","minority language","low-resource","high-resource","mid-resource","rule-based","data-driven","post-editing"].forEach(p=>{
        if(text.toLowerCase().includes(p)) linguistic.add(p);
      });

      for(const [k,v] of bi.entries()) if(v>=2) stat.add(k);
      for(const [k,v] of uni.entries()) if(v>=3) stat.add(k);

      let out = [];
      if(mode==='linguistic') out = Array.from(linguistic).slice(0, 24);
      else if(mode==='statistical') out = Array.from(stat).slice(0, 24);
      else{
        const both = new Set([...Array.from(stat).filter(x=>linguistic.has(x))]);
        const merged = [...both, ...Array.from(linguistic), ...Array.from(stat)];
        out = Array.from(new Set(merged)).slice(0, 28);
      }

      if(out.length===0){
        box.innerHTML = `<span class="muted2">No candidates found. Try a longer text.</span>`;
        return;
      }

      const cls = (mode==='statistical') ? "hl2" : (mode==='hybrid' ? "hl3" : "hl");
      const badgeStyle = (c)=>({
        hl:"border:1px solid rgba(56,242,176,.35);background:rgba(56,242,176,.10)",
        hl2:"border:1px solid rgba(122,215,255,.40);background:rgba(122,215,255,.10)",
        hl3:"border:1px solid rgba(255,209,102,.45);background:rgba(255,209,102,.10)",
      })[c] || "";

      box.innerHTML = `
        <div class="mini muted2" style="margin-bottom:8px">
          Mode: <strong>${mode==="linguistic" ? "Pattern-Based" : mode==="statistical" ? "Frequency-Based" : "Hybrid"}</strong>
          • Candidates shown: <strong>${out.length}</strong>
        </div>
        <div>
          ${out.map(t=>`<span style="display:inline-block;padding:6px 10px;margin:6px 6px 0 0;border-radius:999px;font-weight:1000;${badgeStyle(cls)}">${escapeHtml(t)}</span>`).join("")}
        </div>
      `;
      setStatus("Extraction complete.");
    }

    /***********************
     * Glossary builder (same logic)
     ***********************/
    function addGloss(){
      const term = (document.getElementById('gTerm').value || "").trim();
      const eq = (document.getElementById('gEq').value || "").trim();
      const note = (document.getElementById('gNote').value || "").trim();
      if(!term || !eq){
        setStatus("Add both a term and an equivalent.");
        return;
      }
      const p = loadProgress();
      p.glossary.push({term, eq, note, at: new Date().toISOString()});
      saveProgress(p);

      document.getElementById('gTerm').value = "";
      document.getElementById('gEq').value = "";
      document.getElementById('gNote').value = "";
      renderGloss();
      setStatus("Glossary entry added.");
    }

    function renderGloss(){
      const p = loadProgress();
      const out = document.getElementById('glossOut');
      if(!p.glossary || p.glossary.length===0){
        out.innerHTML = `<span class="muted2">No entries yet.</span>`;
        return;
      }
      const rows = p.glossary.slice().reverse().map((x)=>`
        <div style="display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);margin-top:10px">
          <span style="width:10px;height:10px;border-radius:50%;background:rgba(56,242,176,.9);margin-top:7px;box-shadow:0 0 14px rgba(56,242,176,.35);flex:0 0 auto"></span>
          <div>
            <div style="font-weight:1000"><strong>${escapeHtml(x.term)}</strong> → ${escapeHtml(x.eq)}</div>
            <div class="mini muted2">${escapeHtml(x.note || "—")}</div>
          </div>
        </div>
      `).join("");
      out.innerHTML = rows;
    }
    function exportGloss(){
      const p = loadProgress();
      if(!p.glossary || p.glossary.length===0){
        setStatus("No glossary entries to export.");
        return;
      }
      const lines = ["TERM\tEQUIVALENT\tNOTE"];
      p.glossary.forEach(x=>lines.push(`${x.term}\t${x.eq}\t${x.note || ""}`));
      document.getElementById('glossOut').innerHTML =
        `<pre style="white-space:pre-wrap;margin:0;font-weight:900;font-family:Calibri,Arial,sans-serif">${escapeHtml(lines.join("\n"))}</pre>`;
      setStatus("Glossary exported (copy/paste).");
    }
    function clearGloss(){
      const p = loadProgress();
      p.glossary = [];
      saveProgress(p);
      renderGloss();
      setStatus("Glossary cleared.");
    }

    /***********************
     * MT evaluation trainer
     ***********************/
    const mtCases = [
      {id:"c1", scenario:"You need a fast understanding of a foreign news article to decide whether it is relevant.", correct:"Gisting", why:"Goal is quick comprehension; speed matters more than perfect style."},
      {id:"c2", scenario:"You are preparing an official policy document for publication where accuracy is critical.", correct:"Dissemination", why:"Publication-quality output demands high accuracy and careful review."},
      {id:"c3", scenario:"You are translating a live chat conversation between two users in real time.", correct:"Communication", why:"Real-time use needs speed while keeping meaning."},
    ];

    function renderMTTrainer(){
      const mount = document.getElementById('mtTrainer');
      mount.innerHTML = "";
      mtCases.forEach(c=>{
        const box = document.createElement('div');
        box.style.border = "1px solid rgba(255,255,255,.14)";
        box.style.background = "rgba(0,0,0,.14)";
        box.style.borderRadius = "16px";
        box.style.padding = "14px";
        box.style.marginTop = "12px";

        box.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-bottom:10px">
            <p style="margin:0;font-weight:1000;font-size:22px">${escapeHtml(c.scenario)}</p>
            <div style="font-size:var(--font3);color:var(--muted2);font-weight:900;white-space:nowrap">Choose purpose</div>
          </div>
          <div style="display:grid;gap:10px;margin-top:10px">
            ${["Gisting","Dissemination","Communication"].map(x=>`<div class="opt" role="button" tabindex="0"
              style="padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);cursor:pointer;font-weight:900;font-size:var(--font2)">${x}</div>`).join("")}
          </div>
          <div id="mtfb-${c.id}" style="margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.16);font-size:var(--font2);font-weight:850;display:none"></div>
        `;

        box.querySelectorAll('.opt').forEach(opt=>{
          opt.addEventListener('click', ()=>{
            const ans = opt.textContent.trim();
            const fb = document.getElementById('mtfb-'+c.id);
            const ok = (ans === c.correct);
            fb.style.display = "block";
            fb.style.borderColor = ok ? "rgba(77,255,154,.40)" : "rgba(255,92,124,.45)";
            fb.style.background = ok ? "rgba(77,255,154,.10)" : "rgba(255,92,124,.10)";
            fb.textContent = (ok ? "Correct. " : "Not best choice. ") + c.why;
            setStatus("MT trainer answered.");
          });
        });

        mount.appendChild(box);
      });
    }

    /***********************
     * Global search (flashcards + quizzes + mind maps)
     ***********************/
    function searchAll(q){
      q = (q||"").trim().toLowerCase();
      if(!q){
        setStatus("Enter a search query.");
        return;
      }

      const hits = [];

      flashcards.forEach(c=>{
        if((c.term+" "+c.def+" "+c.hint).toLowerCase().includes(q)){
          hits.push({type:"Flashcard", where: modeLabel(c.deck), title: c.term, extra: c.def});
        }
      });

      quizBank.forEach(x=>{
        if((x.q+" "+x.opts.join(" ")+" "+x.why).toLowerCase().includes(q)){
          hits.push({type:"Quiz", where: modeLabel(x.theme), title: x.q, extra: "Answer: " + x.opts[x.a]});
        }
      });

      maps.forEach(m=>{
        const full = (m.title + " " + m.nodes.map(n=>n.label+" "+(n.sub||[]).join(" ")).join(" ")).toLowerCase();
        if(full.includes(q)){
          hits.push({type:"Mind Map", where: modeLabel(m.theme), title: m.title, extra: "Contains matching node(s)."});
        }
      });

      go('home');
      let box = document.getElementById('searchResultsBox');
      if(!box){
        box = document.createElement('div');
        box.id = 'searchResultsBox';
        box.style.padding = "18px";
        box.style.borderTop = "1px solid rgba(255,255,255,.12)";
        box.style.background = "rgba(0,0,0,.10)";
        document.querySelector('#home .card').appendChild(box);
      }

      if(hits.length===0){
        box.innerHTML = `<div class="muted2">No matches for <strong>${escapeHtml(q)}</strong>.</div>`;
        setStatus("No search results.");
        return;
      }

      const top = hits.slice(0, 12).map(h=>`
        <div style="display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);margin-top:10px">
          <span style="width:10px;height:10px;border-radius:50%;background:rgba(56,242,176,.9);margin-top:7px;box-shadow:0 0 14px rgba(56,242,176,.35);flex:0 0 auto"></span>
          <div>
            <div><strong>${escapeHtml(h.type)}</strong> • ${escapeHtml(h.where)}</div>
            <div class="muted" style="font-weight:1000">${escapeHtml(h.title)}</div>
            <div class="mini muted2">${escapeHtml(h.extra)}</div>
          </div>
        </div>
      `).join("");

      box.innerHTML = `
        <div class="mini muted2" style="margin-bottom:10px">
          Results for <strong>${escapeHtml(q)}</strong> • Showing <strong>${Math.min(12,hits.length)}</strong> of <strong>${hits.length}</strong>
        </div>
        ${top}
      `;
      setStatus("Search results ready.");
    }

    document.getElementById('searchBtn').addEventListener('click', ()=>{
      searchAll(document.getElementById('globalSearch').value);
    });
    document.getElementById('globalSearch').addEventListener('keydown', (e)=>{
      if(e.key === "Enter") searchAll(document.getElementById('globalSearch').value);
    });

    /***********************
     * Random practice button
     ***********************/
    document.getElementById('randomBtn').addEventListener('click', ()=>{
      const pick = Math.random();
      if(pick < 0.40) setDeck('weak');
      else if(pick < 0.70) setQuizMode('mixed');
      else setMap('all');
      setStatus("Random practice launched.");
    });

    /***********************
     * Practice routing helper
     ***********************/
    function openPractice(target, theme){
      if(target === 'flashcards'){
        setDeck(theme === 'term' ? 'terminology' : (theme||'all'));
      }else if(target === 'quizzes'){
        setQuizMode(theme || 'mixed');
      }else if(target === 'mindmaps'){
        setMap(theme || 'all');
      }else if(target === 'studio'){
        go('studio');
        setStatus("Studio opened.");
      }else{
        go(target);
      }
    }

    /***********************
     * Utilities
     ***********************/
    function pickRandom(arr, n){
      const a = [...arr];
      const out = [];
      while(a.length && out.length < n){
        out.push(a.splice(Math.floor(Math.random()*a.length), 1)[0]);
      }
      return out;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /***********************
     * First mount
     ***********************/
    initPDFLinks();
    mountFlash();
    newQuiz();
    renderMaps();
    renderGloss();
    renderMTTrainer();
  </script>
</body>
</html>
